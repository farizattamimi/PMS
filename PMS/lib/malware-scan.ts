import { mkdir, writeFile } from 'fs/promises'
import path from 'path'
import { quarantineDocumentsDir } from '@/lib/document-storage'

export type MalwareScanVerdict = 'CLEAN' | 'SUSPICIOUS' | 'ERROR'

export type MalwareScanResult = {
  verdict: MalwareScanVerdict
  reason?: string
}

const EICAR = 'X5O!P%@AP[4\\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*'

function requiredInThisEnv(): boolean {
  if (process.env.MALWARE_SCAN_REQUIRED === 'true') return true
  return process.env.NODE_ENV === 'production'
}

async function remoteScan(buffer: Buffer, fileName: string, mimeType: string): Promise<MalwareScanResult | null> {
  const endpoint = process.env.MALWARE_SCAN_ENDPOINT
  if (!endpoint) return null
  try {
    const res = await fetch(endpoint, {
      method: 'POST',
      headers: {
        'content-type': 'application/octet-stream',
        'x-file-name': fileName,
        'x-file-type': mimeType || 'application/octet-stream',
        ...(process.env.MALWARE_SCAN_TOKEN ? { authorization: `Bearer ${process.env.MALWARE_SCAN_TOKEN}` } : {}),
      },
      body: new Uint8Array(buffer),
    })
    if (!res.ok) {
      return { verdict: 'ERROR', reason: `scanner_http_${res.status}` }
    }
    const json = (await res.json().catch(() => ({}))) as { verdict?: string; reason?: string }
    if (json.verdict === 'CLEAN' || json.verdict === 'SUSPICIOUS') {
      return { verdict: json.verdict, reason: json.reason }
    }
    return { verdict: 'ERROR', reason: 'scanner_invalid_payload' }
  } catch (err: any) {
    return { verdict: 'ERROR', reason: err?.message ?? 'scanner_request_failed' }
  }
}

function localHeuristics(buffer: Buffer): MalwareScanResult {
  const asText = buffer.toString('utf8')
  if (asText.includes(EICAR)) return { verdict: 'SUSPICIOUS', reason: 'eicar_signature' }
  if (/<script[\s>]/i.test(asText)) return { verdict: 'SUSPICIOUS', reason: 'embedded_script_tag' }
  return { verdict: 'CLEAN' }
}

export async function scanUpload(buffer: Buffer, fileName: string, mimeType: string): Promise<MalwareScanResult> {
  const remote = await remoteScan(buffer, fileName, mimeType)
  if (remote) return remote

  const local = localHeuristics(buffer)
  if (requiredInThisEnv() && local.verdict === 'CLEAN' && !process.env.MALWARE_SCAN_ALLOW_LOCAL_HEURISTICS) {
    return { verdict: 'ERROR', reason: 'scanner_not_configured' }
  }
  return local
}

export async function quarantineUpload(buffer: Buffer, originalName: string): Promise<string> {
  const ext = (originalName.split('.').pop() ?? 'bin').replace(/[^a-zA-Z0-9]/g, '').toLowerCase() || 'bin'
  const safeName = `${Date.now()}-${Math.random().toString(36).slice(2)}.${ext}`
  const dir = quarantineDocumentsDir()
  await mkdir(dir, { recursive: true })
  const p = path.join(dir, safeName)
  await writeFile(p, buffer)
  return p
}
